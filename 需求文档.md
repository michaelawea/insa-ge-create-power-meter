# STM32功率计项目需求文档

## 1. 项目背景

本项目旨在开发一个基于STM32L052K6T6微控制器的智能功率计系统，实现电压、电流和功率的实时测量、显示、存储和通信功能。系统将提供友好的人机界面，支持数据记录和统计分析。

## 2. 功能需求

### 2.1 人机界面（IHM）需求

#### 2.1.1 菜单系统
- **功能菜单实现**
  - 主菜单包含所有功能入口
  - 层级菜单结构，支持子菜单
  - 菜单项包括：测量、显示、存储、通信、设置等

#### 2.1.2 交互控制
- **旋转编码器操作**
  - 顺时针旋转：菜单向下/数值增加
  - 逆时针旋转：菜单向上/数值减少
  - 在功能页面内，旋转编码器用于参数调节

- **按钮操作**
  - 短按：确认选择/进入子菜单
  - 长按（>2秒）：取消/返回上级菜单
  - 在主菜单长按：进入系统设置

#### 2.1.3 导航逻辑
- 任何功能页面激活时，按下按钮返回主菜单
- 超时自动返回（可选）：无操作30秒后返回主菜单

### 2.2 测量功能需求

#### 2.2.1 瞬时测量
- **测量参数**
  - 电压（V）：量程 0-30V，精度 ±0.1V
  - 电流（A）：量程 0-5A，精度 ±0.01A
  - 功率（W）：P = V × I，实时计算
  - 采样率：10Hz（每100ms更新一次）

#### 2.2.2 累积计算
- **能量累积**
  - 公式：E = ∫P·dt（功率对时间的积分）
  - 单位：Wh（瓦时）或 kWh（千瓦时）
  - 精度：0.001 kWh
  - 重置功能：通过菜单选项清零累积能量

#### 2.2.3 峰值记录
- **记录参数**
  - 电压峰值（Vmax）
  - 电流峰值（Imax）
  - 功率峰值（Pmax）
  - 记录时间戳（可选）
- **重置功能**
  - 独立重置各参数峰值
  - 批量重置所有峰值

### 2.3 显示功能需求

#### 2.3.1 简单显示模式
- **实时数据显示**
  ```
  V: 12.5V  I: 2.35A
  P: 29.4W  E: 1.234kWh
  ```
- **更新频率**：与测量频率同步（10Hz）
- **显示格式**：自动调整小数位数

#### 2.3.2 图形显示模式
- **曲线绘制**
  - X轴：时间（可调整时间窗口）
  - Y轴：选定参数（V/I/P）
  - 显示最近N个采样点（N=128）
- **显示选项**
  - 单参数曲线
  - 双参数对比（如V和I）
  - 自动缩放/手动缩放

### 2.4 存储功能需求

#### 2.4.1 RAM存储
- **数据结构**
  ```c
  typedef struct {
      uint32_t timestamp;    // 时间戳
      uint16_t voltage;      // 电压值
      uint16_t current;      // 电流值
      uint16_t power;        // 功率值
  } MeasurementData;
  ```
- **缓冲区大小**：最少存储1000条记录
- **循环缓冲**：满后覆盖最旧数据

#### 2.4.2 非易失性存储
- **存储选项**
  - 自动存储：定期保存到Flash
  - 手动存储：用户触发保存
  - 仅RAM模式：不写入Flash
- **Flash分区**
  - 数据区：存储测量记录
  - 配置区：存储系统设置
  - 统计区：存储累积统计数据

#### 2.4.3 数据统计
- **统计参数**
  - 平均值：电压、电流、功率
  - 最大/最小值
  - 总能量消耗
  - 运行时间
  - 数据记录数量

### 2.5 通信功能需求

#### 2.5.1 实时通信
- **通信参数**
  - 接口：UART1
  - 波特率：115200 bps
  - 数据格式：8N1
  - 协议：自定义ASCII协议

- **数据格式**
  ```
  $DATA,timestamp,voltage,current,power,energy\r\n
  $STAT,avg_v,avg_i,avg_p,total_e,runtime\r\n
  ```

#### 2.5.2 数据传输
- **传输模式**
  - 实时模式：持续发送当前测量值
  - 批量模式：发送存储的历史数据
  - 命令模式：响应PC端命令

- **传输控制**
  - 开始/停止传输
  - 选择传输内容
  - 传输后清空选项
  - 传输进度显示

#### 2.5.3 PC端功能（可选）
- **统计分析**
  - 接收并解析数据
  - 生成统计报表
  - 导出CSV/Excel格式
  - 图形化显示

### 2.6 系统配置需求

#### 2.6.1 可配置参数
- **测量设置**
  - 电压/电流量程
  - 采样率（1-100Hz）
  - 滤波参数

- **显示设置**
  - 屏幕亮度
  - 自动关屏时间
  - 显示单位

- **存储设置**
  - 存储间隔
  - 存储容量限制
  - 自动清理策略

## 3. 非功能需求

### 3.1 性能需求
- 测量响应时间：< 100ms
- 菜单响应时间：< 50ms
- 数据存储速度：> 100条/秒
- 功耗：< 100mA @ 3.3V

### 3.2 可靠性需求
- 连续运行时间：> 30天
- 数据保存可靠性：掉电不丢失
- 错误恢复：异常自动重启

### 3.3 可维护性需求
- 模块化设计
- 详细代码注释
- 调试信息输出
- 版本管理

## 4. 交付物

### 4.1 软件交付
- **可执行文件**
  - `power_meter.elf`：可直接烧录的二进制文件
  - `power_meter.hex`：Intel HEX格式文件
  - `power_meter.bin`：纯二进制格式文件

- **源代码**
  - 完整的STM32CubeIDE工程
  - 所有源文件（.c/.h）
  - 构建脚本和配置文件

### 4.2 文档交付
- **设计文档**
  - 系统架构图
  - 软件流程图
  - 接口定义文档
  - 通信协议说明

- **内存布局文档**
  ```
  RAM分配：
  - 系统栈：1KB
  - 系统堆：512B
  - 全局变量：2KB
  - 数据缓冲区：4KB
  
  Flash分配：
  - 程序代码：20KB
  - 配置数据：2KB
  - 测量数据：10KB
  ```

- **用户手册**
  - 操作说明
  - 功能介绍
  - 故障排除

### 4.3 测试交付
- 单元测试代码
- 集成测试脚本
- 测试报告

## 5. 验收标准

### 5.1 功能测试
- **测试台验证**
  - 使用标准信号源验证测量精度
  - 电压精度：±1%
  - 电流精度：±1%
  - 功率计算正确性

### 5.2 用户测试
- **界面测试**
  - 菜单导航流畅
  - 显示清晰可读
  - 响应及时

- **功能完整性**
  - 所有菜单功能可用
  - 数据存储/读取正常
  - 通信稳定可靠

### 5.3 代码质量
- **编码规范**
  - 遵循MISRA-C标准（建议）
  - 函数注释完整
  - 变量命名规范

- **文档完整性**
  - 所有交付物齐全
  - 文档内容准确
  - 版本信息清晰

## 6. 开发里程碑

| 阶段 | 任务 | 预计完成时间 |
|------|------|-------------|
| 第一阶段 | 基础测量功能实现 | 第2周 |
| 第二阶段 | 菜单系统和显示功能 | 第4周 |
| 第三阶段 | 存储功能实现 | 第6周 |
| 第四阶段 | 通信功能开发 | 第8周 |
| 第五阶段 | 系统集成测试 | 第9周 |
| 第六阶段 | 文档编写和交付 | 第10周 |

## 7. 风险评估

### 7.1 技术风险
- ADC精度可能受温度影响
- Flash写入次数限制（10万次）
- 实时性能约束

### 7.2 缓解措施
- 实施温度补偿算法
- 使用磨损均衡算法
- 优化中断处理程序

## 8. 附录

### 8.1 参考资料
- STM32L052K6T6数据手册
- STM32L0 HAL库文档
- SSD1306 OLED控制器手册

### 8.2 术语定义
- **IHM**：Interface Homme-Machine（人机界面）
- **ADC**：Analog-to-Digital Converter（模数转换器）
- **UART**：Universal Asynchronous Receiver-Transmitter（通用异步收发器）
- **Flash**：非易失性存储器